import t from"rn-fetch-blob";import{btoa as e}from"abab";import a,{createContext as r,useContext as s,useState as o,useCallback as n,useMemo as i}from"react";const c=async({path:a})=>{const r=(await t.fs.hash(a,"md5")).replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ").map(t=>parseInt(t)),s=String.fromCharCode(...r);return e(s)};function d(){return(d=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var a=arguments[e];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(t[r]=a[r])}return t}).apply(this,arguments)}let l=0;const h=({directUploadsUrl:e,file:a,headers:r,onStatusChange:s})=>{const o=++l;let n,i=!1;const h=()=>{n&&(i=!0,n.cancel())},p=t=>{s(d({},t,{id:o,cancel:h,file:a}))};return p({status:"waiting"}),new Promise(async s=>{try{const o=await(async({directUploadsUrl:t,file:e,headers:a={}})=>{const r=await c({path:e.path});if(!r)throw new Error(`Failed to get file checksum. Path: ${e.path}`);const s={filename:e.name,content_type:e.type||"image/jpeg",byte_size:e.size,checksum:r};return e.metadata&&(s.metadata=e.metadata),(await fetch(t,{method:"POST",body:JSON.stringify({blob:s}),headers:d({"Content-Type":"application/json"},a)})).json()})({directUploadsUrl:e,file:a,headers:r}),{url:l,headers:h}=o.direct_upload,u=t.wrap(a.path);n=t.fetch("PUT",l,h,u),n.uploadProgress({interval:250},(t,e)=>{p({status:"uploading",progress:t/e*100,totalBytes:e,uploadedBytes:t})}).then(t=>{const e=t.info().status;p(e>=200&&e<400?{status:"success",signed_id:o.signed_id}:{status:"error",error:new Error("Response not success")}),s(o.signed_id)}).catch(t=>{p(i?{status:"canceled"}:{status:"error",error:t}),s()})}catch(t){return p({status:"error",error:t}),s()}})},p=r({host:"http://localhost:3000",mountPath:"/rails/active_storage",headers:{}}),{Provider:u}=p,m=({host:t,mountPath:e,headers:r,children:s})=>a.createElement(u,{value:{host:t,mountPath:e,headers:r}},s),f=({onSuccess:t}={})=>{const{directUploadsUrl:e,headers:a}=(()=>{const t=s(p),e=t.mountPath||"/rails/active_storage";return d({},t,{mountPath:e,directUploadsUrl:`${t.host}${e}/direct_uploads`})})(),[r,c]=o([]),l=n(t=>{c(e=>((t,e,a="id")=>{const r=[...t],s=r.findIndex(t=>t[a]===e[a]);return s>=0?r[s]=e:r.push(e),r})(e,t))},[]),u=n(async r=>{const s=(await Promise.all(r.map(t=>h({file:t,directUploadsUrl:e,headers:a,onStatusChange:l})))).filter(t=>!!t);return s.length>0&&t&&t({signedIds:s}),{signedIds:s}},[l,t]),m=i(()=>r.some(t=>"uploading"===t.status),[r]);return{upload:u,uploads:r,isUploading:m,resetUploads:()=>c([]),removeUpload:t=>c(r.filter(e=>e.id!==t))}},g=({children:t,onSuccess:e})=>t(f({onSuccess:e}));export{m as ActiveStorageProvider,g as DirectUpload,c as checksum,h as directUpload,f as useDirectUpload};
//# sourceMappingURL=react-native-activestorage.modern.js.map
