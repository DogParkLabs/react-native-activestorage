import r from"rn-fetch-blob";import{btoa as e}from"abab";import t,{createContext as n,useContext as o,useState as a,useCallback as i,useMemo as s}from"react";var u=function(t){var n=t.path;try{return Promise.resolve(r.fs.hash(n,"md5")).then(function(r){var t=r.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ").map(function(r){return parseInt(r)}),n=String.fromCharCode.apply(String,t);return e(n)})}catch(r){return Promise.reject(r)}};function c(){return(c=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r}).apply(this,arguments)}var d=0,l=function(e){var t,n=e.directUploadsUrl,o=e.file,a=e.headers,i=e.onStatusChange,s=++d,l=!1,h=function(){t&&(l=!0,t.cancel())},f=function(r){i(c({},r,{id:s,cancel:h,file:o}))};return f({status:"waiting"}),new Promise(function(e){try{return Promise.resolve(function(i,s){try{var d=Promise.resolve(function(r){var e=r.directUploadsUrl,t=r.file,n=r.headers,o=void 0===n?{}:n;try{return Promise.resolve(u({path:t.path})).then(function(r){if(!r)throw new Error("Failed to get file checksum. Path: "+t.path);var n={filename:t.name,content_type:t.type||"image/jpeg",byte_size:t.size,checksum:r};return t.metadata&&(n.metadata=t.metadata),Promise.resolve(fetch(e,{method:"POST",body:JSON.stringify({blob:n}),headers:c({"Content-Type":"application/json"},o)})).then(function(r){return r.json()})})}catch(r){return Promise.reject(r)}}({directUploadsUrl:n,file:o,headers:a})).then(function(n){var a=n.direct_upload,i=a.url,s=a.headers,u=r.wrap(o.path);(t=r.fetch("PUT",i,s,u)).uploadProgress({interval:250},function(r,e){f({status:"uploading",progress:r/e*100,totalBytes:e,uploadedBytes:r})}).then(function(r){var t=r.info().status;f(t>=200&&t<400?{status:"success",signed_id:n.signed_id}:{status:"error",error:new Error("Response not success")}),e(n.signed_id)}).catch(function(r){f(l?{status:"canceled"}:{status:"error",error:r}),e()})})}catch(r){return s(r)}return d&&d.then?d.then(void 0,s):d}(0,function(r){return f({status:"error",error:r}),e()}))}catch(r){return Promise.reject(r)}})},h=n({host:"http://localhost:3000",mountPath:"/rails/active_storage",headers:{}}),f=h.Provider,p=function(r){return t.createElement(f,{value:{host:r.host,mountPath:r.mountPath,headers:r.headers}},r.children)},m=function(r){var e,t,n=(void 0===r?{}:r).onSuccess,u=c({},e=o(h),{mountPath:t=e.mountPath||"/rails/active_storage",directUploadsUrl:""+e.host+t+"/direct_uploads"}),d=u.directUploadsUrl,f=u.headers,p=a([]),m=p[0],v=p[1],g=i(function(r){v(function(e){return function(r,e,t){void 0===t&&(t="id");var n=[].concat(r),o=n.findIndex(function(r){return r[t]===e[t]});return o>=0?n[o]=e:n.push(e),n}(e,r)})},[]),P=i(function(r){try{return Promise.resolve(Promise.all(r.map(function(r){return l({file:r,directUploadsUrl:d,headers:f,onStatusChange:g})}))).then(function(r){var e=r.filter(function(r){return!!r});return e.length>0&&n&&n({signedIds:e}),{signedIds:e}})}catch(r){return Promise.reject(r)}},[g,n]),y=s(function(){return m.some(function(r){return"uploading"===r.status})},[m]);return{upload:P,uploads:m,isUploading:y,resetUploads:function(){return v([])},removeUpload:function(r){return v(m.filter(function(e){return e.id!==r}))}}},v=function(r){return(0,r.children)(m({onSuccess:r.onSuccess}))};export{p as ActiveStorageProvider,v as DirectUpload,u as checksum,l as directUpload,m as useDirectUpload};
//# sourceMappingURL=react-native-activestorage.module.js.map
