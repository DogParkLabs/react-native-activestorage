import e from"rn-fetch-blob";import{btoa as r}from"abab";import t,{createContext as n,useContext as o,useState as a,useCallback as s,useMemo as i}from"react";var c,u=function(t){var n=t.path;try{return Promise.resolve(e.fs.hash(n,"md5")).then(function(e){var t=e.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ").map(function(e){return parseInt(e)}),n=String.fromCharCode.apply(String,t);return r(n)})}catch(e){return Promise.reject(e)}};function l(){return(l=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}!function(e){e.success="success",e.uploading="uploading",e.error="error",e.waiting="waiting",e.canceled="canceled"}(c||(c={}));var d=0,f=function(r){var t,n=r.directUploadsUrl,o=r.file,a=r.headers,s=r.onStatusChange,i=++d,f=!1,h=function(){t&&(f=!0,t.cancel())},p=function(e){s(l({},e,{id:i,cancel:h,file:o}))};return p({status:c.waiting}),new Promise(function(r){try{return Promise.resolve(function(s,i){try{var d=Promise.resolve(function(e){var r=e.directUploadsUrl,t=e.file,n=e.headers,o=void 0===n?{}:n;try{return Promise.resolve(u({path:t.path})).then(function(e){if(!e)throw new Error("Failed to get file checksum. Path: "+t.path);var n={filename:t.name,content_type:t.type||"image/jpeg",byte_size:t.size,checksum:e};return t.metadata&&(n.metadata=t.metadata),Promise.resolve(fetch(r,{method:"POST",body:JSON.stringify({blob:n}),headers:l({"Content-Type":"application/json"},o)})).then(function(e){return e.json()})})}catch(e){return Promise.reject(e)}}({directUploadsUrl:n,file:o,headers:a})).then(function(n){var a=n.direct_upload,s=a.url,i=a.headers,u=e.wrap(o.path);(t=e.fetch("PUT",s,i,u)).uploadProgress({interval:250},function(e,r){p({status:c.uploading,progress:e/r*100,totalBytes:r,uploadedBytes:e})}).then(function(e){var t=e.info().status;p(t>=200&&t<400?{status:c.success,signed_id:n.signed_id}:{status:c.error,error:new Error("Response not success")}),r(n.signed_id)}).catch(function(e){p(f?{status:c.canceled}:{status:c.error,error:e}),r()})})}catch(e){return i(e)}return d&&d.then?d.then(void 0,i):d}(0,function(e){return p({status:c.error,error:e}),r()}))}catch(e){return Promise.reject(e)}})},h=n({host:"http://localhost:3000",mountPath:"/rails/active_storage",headers:{}}),p=h.Provider,m=function(e){return t.createElement(p,{value:{host:e.host,mountPath:e.mountPath,headers:e.headers}},e.children)},g=function(e){var r,t,n=void 0===e?{}:e,u=n.onSuccess,d=n.onError,p=l({},r=o(h),{mountPath:t=r.mountPath||"/rails/active_storage",directUploadsUrl:""+r.host+t+"/direct_uploads"}),m=p.directUploadsUrl,g=p.headers,v=a([]),P=v[0],y=v[1],U=s(function(e){y(function(r){return function(e,r,t){void 0===t&&(t="id");var n=[].concat(e),o=n.findIndex(function(e){return e[t]===r[t]});return o>=0?n[o]=r:n.push(r),n}(r,e)})},[]),b=s(function(e){try{return Promise.resolve(Promise.all(e.map(function(e){return f({file:e,directUploadsUrl:m,headers:g,onStatusChange:U})}))).then(function(r){var t=r.filter(function(e){return!!e});return t.length>0&&u&&u({signedIds:t}),e.length>t.length&&d&&d(),{signedIds:t}})}catch(e){return Promise.reject(e)}},[U,u,d]),j=i(function(){return P.some(function(e){return e.status===c.uploading})},[P]),w=i(function(){return P.filter(function(e){return e.status===c.success})},[P]);return{upload:b,uploads:P,isUploading:j,successfulUploads:w,resetUploads:function(){return y([])},removeUpload:function(e){return y(P.filter(function(r){return r.id!==e}))}}},v=function(e){return(0,e.children)(g({onSuccess:e.onSuccess}))};export{m as ActiveStorageProvider,v as DirectUpload,c as DirectUploadResultStatus,u as checksum,f as directUpload,g as useDirectUpload};
//# sourceMappingURL=react-native-activestorage.module.js.map
