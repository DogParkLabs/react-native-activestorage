var t=require("react-native-blob-util"),e=require("abab"),r=require("react");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o,s=n(t),a=n(r),u=function(t){var r=t.path;try{return Promise.resolve(s.default.fs.hash(r,"md5")).then(function(t){var r=t.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ").map(function(t){return parseInt(t)}),n=String.fromCharCode.apply(String,r);return e.btoa(n)})}catch(t){return Promise.reject(t)}};function i(){return(i=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}exports.DirectUploadResultStatus=void 0,(o=exports.DirectUploadResultStatus||(exports.DirectUploadResultStatus={})).success="success",o.uploading="uploading",o.error="error",o.waiting="waiting",o.canceled="canceled";var c=0,l=function(t){var e,r=t.directUploadsUrl,n=t.file,o=t.headers,a=t.onStatusChange,l=++c,d=!1,p=function(){e&&(d=!0,e.cancel())},f=function(t){a(i({},t,{id:l,cancel:p,file:n}))};return f({status:exports.DirectUploadResultStatus.waiting}),new Promise(function(t){try{return Promise.resolve(function(a,c){try{var l=Promise.resolve(function(t){var e=t.directUploadsUrl,r=t.file,n=t.headers,o=void 0===n?{}:n;try{return Promise.resolve(u({path:r.path})).then(function(t){if(!t)throw new Error("Failed to get file checksum. Path: "+r.path);var n={filename:r.name,content_type:r.type||"image/jpeg",byte_size:r.size,checksum:t};return r.metadata&&(n.metadata=r.metadata),Promise.resolve(fetch(e,{method:"POST",body:JSON.stringify({blob:n}),headers:i({"Content-Type":"application/json"},o)})).then(function(t){return t.json()})})}catch(t){return Promise.reject(t)}}({directUploadsUrl:r,file:n,headers:o})).then(function(r){var o=r.direct_upload,a=o.url,u=o.headers,i=s.default.wrap(n.path);(e=s.default.fetch("PUT",a,u,i)).uploadProgress({interval:250},function(t,e){f({status:exports.DirectUploadResultStatus.uploading,progress:t/e*100,totalBytes:e,uploadedBytes:t})}).then(function(e){var n=e.info().status;f(n>=200&&n<400?{status:exports.DirectUploadResultStatus.success,signed_id:r.signed_id}:{status:exports.DirectUploadResultStatus.error,error:new Error("Response not success")}),t(r.signed_id)}).catch(function(e){f(d?{status:exports.DirectUploadResultStatus.canceled}:{status:exports.DirectUploadResultStatus.error,error:e}),t()})})}catch(t){return c(t)}return l&&l.then?l.then(void 0,c):l}(0,function(e){return f({status:exports.DirectUploadResultStatus.error,error:e}),t()}))}catch(t){return Promise.reject(t)}})},d=r.createContext({host:"http://localhost:3000",mountPath:"/rails/active_storage",headers:{}}),p=d.Provider,f=function(t){var e,n,o=void 0===t?{}:t,s=o.onSuccess,a=o.onError,u=i({},e=r.useContext(d),{mountPath:n=e.mountPath||"/rails/active_storage",directUploadsUrl:""+e.host+n+"/direct_uploads"}),c=u.directUploadsUrl,p=u.headers,f=r.useState([]),h=f[0],v=f[1],m=r.useCallback(function(t){v(function(e){return function(t,e,r){void 0===r&&(r="id");var n=[].concat(t),o=n.findIndex(function(t){return t[r]===e[r]});return o>=0?n[o]=e:n.push(e),n}(e,t)})},[]),g=r.useCallback(function(t){try{return Promise.resolve(Promise.all(t.map(function(t){return l({file:t,directUploadsUrl:c,headers:p,onStatusChange:m})}))).then(function(e){var r=e.filter(function(t){return!!t});return r.length>0&&s&&s({signedIds:r}),t.length>r.length&&a&&a(),{signedIds:r}})}catch(t){return Promise.reject(t)}},[m,s,a]),U=r.useMemo(function(){return h.some(function(t){return t.status===exports.DirectUploadResultStatus.uploading})},[h]),P=r.useMemo(function(){return h.filter(function(t){return t.status===exports.DirectUploadResultStatus.success})},[h]);return{upload:g,uploads:h,isUploading:U,successfulUploads:P,resetUploads:function(){return v([])},removeUpload:function(t){return v(h.filter(function(e){return e.id!==t}))}}};exports.ActiveStorageProvider=function(t){return a.default.createElement(p,{value:{host:t.host,mountPath:t.mountPath,headers:t.headers}},t.children)},exports.DirectUpload=function(t){return(0,t.children)(f({onSuccess:t.onSuccess}))},exports.checksum=u,exports.directUpload=l,exports.useDirectUpload=f;
//# sourceMappingURL=react-native-activestorage.js.map
