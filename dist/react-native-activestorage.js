var e=require("rn-fetch-blob"),t=require("abab"),r=require("react");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o,a=n(e),s=n(r),u=function(e){var r=e.path;try{return Promise.resolve(a.default.fs.hash(r,"md5")).then(function(e){var r=e.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ").map(function(e){return parseInt(e)}),n=String.fromCharCode.apply(String,r);return t.btoa(n)})}catch(e){return Promise.reject(e)}};function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}!function(e){e.success="success",e.uploading="uploading",e.error="error",e.waiting="waiting",e.canceled="canceled"}(o||(o={}));var c=0,l=function(e){var t,r=e.directUploadsUrl,n=e.file,s=e.headers,l=e.onStatusChange,d=++c,f=!1,h=function(){t&&(f=!0,t.cancel())},p=function(e){l(i({},e,{id:d,cancel:h,file:n}))};return p({status:o.waiting}),new Promise(function(e){try{return Promise.resolve(function(c,l){try{var d=Promise.resolve(function(e){var t=e.directUploadsUrl,r=e.file,n=e.headers,o=void 0===n?{}:n;try{return Promise.resolve(u({path:r.path})).then(function(e){if(!e)throw new Error("Failed to get file checksum. Path: "+r.path);var n={filename:r.name,content_type:r.type||"image/jpeg",byte_size:r.size,checksum:e};return r.metadata&&(n.metadata=r.metadata),Promise.resolve(fetch(t,{method:"POST",body:JSON.stringify({blob:n}),headers:i({"Content-Type":"application/json"},o)})).then(function(e){return e.json()})})}catch(e){return Promise.reject(e)}}({directUploadsUrl:r,file:n,headers:s})).then(function(r){var s=r.direct_upload,u=s.url,i=s.headers,c=a.default.wrap(n.path);(t=a.default.fetch("PUT",u,i,c)).uploadProgress({interval:250},function(e,t){p({status:o.uploading,progress:e/t*100,totalBytes:t,uploadedBytes:e})}).then(function(t){var n=t.info().status;p(n>=200&&n<400?{status:o.success,signed_id:r.signed_id}:{status:o.error,error:new Error("Response not success")}),e(r.signed_id)}).catch(function(t){p(f?{status:o.canceled}:{status:o.error,error:t}),e()})})}catch(e){return l(e)}return d&&d.then?d.then(void 0,l):d}(0,function(t){return p({status:o.error,error:t}),e()}))}catch(e){return Promise.reject(e)}})},d=r.createContext({host:"http://localhost:3000",mountPath:"/rails/active_storage",headers:{}}),f=d.Provider,h=function(e){var t,n,a=void 0===e?{}:e,s=a.onSuccess,u=a.onError,c=i({},t=r.useContext(d),{mountPath:n=t.mountPath||"/rails/active_storage",directUploadsUrl:""+t.host+n+"/direct_uploads"}),f=c.directUploadsUrl,h=c.headers,p=r.useState([]),m=p[0],v=p[1],g=r.useCallback(function(e){v(function(t){return function(e,t,r){void 0===r&&(r="id");var n=[].concat(e),o=n.findIndex(function(e){return e[r]===t[r]});return o>=0?n[o]=t:n.push(t),n}(t,e)})},[]),P=r.useCallback(function(e){try{return Promise.resolve(Promise.all(e.map(function(e){return l({file:e,directUploadsUrl:f,headers:h,onStatusChange:g})}))).then(function(t){var r=t.filter(function(e){return!!e});return r.length>0&&s&&s({signedIds:r}),e.length>r.length&&u&&u(),{signedIds:r}})}catch(e){return Promise.reject(e)}},[g,s,u]),U=r.useMemo(function(){return m.some(function(e){return e.status===o.uploading})},[m]),y=r.useMemo(function(){return m.filter(function(e){return e.status===o.success})},[m]);return{upload:P,uploads:m,isUploading:U,successfulUploads:y,resetUploads:function(){return v([])},removeUpload:function(e){return v(m.filter(function(t){return t.id!==e}))}}};exports.ActiveStorageProvider=function(e){return s.default.createElement(f,{value:{host:e.host,mountPath:e.mountPath,headers:e.headers}},e.children)},exports.DirectUpload=function(e){return(0,e.children)(h({onSuccess:e.onSuccess}))},exports.checksum=u,exports.directUpload=l,exports.useDirectUpload=h;
//# sourceMappingURL=react-native-activestorage.js.map
