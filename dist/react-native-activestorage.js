var e=require("rn-fetch-blob"),t=require("abab"),r=require("react");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(e),a=n(r),s=function(e){var r=e.path;try{return Promise.resolve(o.default.fs.hash(r,"md5")).then(function(e){var r=e.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ").map(function(e){return parseInt(e)}),n=String.fromCharCode.apply(String,r);return t.btoa(n)})}catch(e){return Promise.reject(e)}};function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var u=0,c=function(e){var t,r=e.directUploadsUrl,n=e.file,a=e.headers,c=e.onStatusChange,l=++u,d=!1,f=function(){t&&(d=!0,t.cancel())},h=function(e){c(i({},e,{id:l,cancel:f,file:n}))};return h({status:"waiting"}),new Promise(function(e){try{return Promise.resolve(function(u,c){try{var l=Promise.resolve(function(e){var t=e.directUploadsUrl,r=e.file,n=e.headers,o=void 0===n?{}:n;try{return Promise.resolve(s({path:r.path})).then(function(e){if(!e)throw new Error("Failed to get file checksum. Path: "+r.path);var n={filename:r.name,content_type:r.type||"image/jpeg",byte_size:r.size,checksum:e};return r.metadata&&(n.metadata=r.metadata),Promise.resolve(fetch(t,{method:"POST",body:JSON.stringify({blob:n}),headers:i({"Content-Type":"application/json"},o)})).then(function(e){return e.json()})})}catch(e){return Promise.reject(e)}}({directUploadsUrl:r,file:n,headers:a})).then(function(r){var a=r.direct_upload,s=a.url,i=a.headers,u=o.default.wrap(n.path);(t=o.default.fetch("PUT",s,i,u)).uploadProgress({interval:250},function(e,t){h({status:"uploading",progress:e/t*100,totalBytes:t,uploadedBytes:e})}).then(function(t){var n=t.info().status;h(n>=200&&n<400?{status:"success",signed_id:r.signed_id}:{status:"error",error:new Error("Response not success")}),e(r.signed_id)}).catch(function(t){h(d?{status:"canceled"}:{status:"error",error:t}),e()})})}catch(e){return c(e)}return l&&l.then?l.then(void 0,c):l}(0,function(t){return h({status:"error",error:t}),e()}))}catch(e){return Promise.reject(e)}})},l=r.createContext({host:"http://localhost:3000",mountPath:"/rails/active_storage",headers:{}}),d=l.Provider,f=function(e){var t,n,o=(void 0===e?{}:e).onSuccess,a=i({},t=r.useContext(l),{mountPath:n=t.mountPath||"/rails/active_storage",directUploadsUrl:""+t.host+n+"/direct_uploads"}),s=a.directUploadsUrl,u=a.headers,d=r.useState([]),f=d[0],h=d[1],p=r.useCallback(function(e){h(function(t){return function(e,t,r){void 0===r&&(r="id");var n=[].concat(e),o=n.findIndex(function(e){return e[r]===t[r]});return o>=0?n[o]=t:n.push(t),n}(t,e)})},[]),m=r.useCallback(function(e){try{return Promise.resolve(Promise.all(e.map(function(e){return c({file:e,directUploadsUrl:s,headers:u,onStatusChange:p})}))).then(function(e){var t=e.filter(function(e){return!!e});return t.length>0&&o&&o({signedIds:t}),{signedIds:t}})}catch(e){return Promise.reject(e)}},[p,o]),v=r.useMemo(function(){return f.some(function(e){return"uploading"===e.status})},[f]);return{upload:m,uploads:f,isUploading:v,resetUploads:function(){return h([])},removeUpload:function(e){return h(f.filter(function(t){return t.id!==e}))}}};exports.ActiveStorageProvider=function(e){return a.default.createElement(d,{value:{host:e.host,mountPath:e.mountPath,headers:e.headers}},e.children)},exports.DirectUpload=function(e){return(0,e.children)(f({onSuccess:e.onSuccess}))},exports.checksum=s,exports.directUpload=c,exports.useDirectUpload=f;
//# sourceMappingURL=react-native-activestorage.js.map
